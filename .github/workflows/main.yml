name: Build TESTPLUGIN (.NET 4.8 - FULL DIAGNOSTICS)
on:
  workflow_dispatch:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ§© Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      
      - name: ğŸ“¦ Download Revit API DLLs
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download v1.0.0 --repo SHarpreet89/MyRevitAddin --pattern RevitApis.zip --dir .
          Expand-Archive RevitApis.zip -DestinationPath revapi -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPI.dll' | Select -First 1).FullName RevitAPI.dll -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPIUI.dll' | Select -First 1).FullName RevitAPIUI.dll -Force
      
      - name: ğŸ—ï¸ MSBuild TESTPLUGIN x64
        run: |
          msbuild TESTPLUGIN.csproj /p:Configuration=Release /p:Platform=x64 /maxcpucount /v:normal
      
      - name: ğŸ”¬ DEEP DIAGNOSTICS - All DLL Metadata
        shell: pwsh
        run: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "ğŸ” CRITICAL DIAGNOSTICS FOR LINE 146 CRASH" -ForegroundColor Yellow
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          $dll = Get-ChildItem -Recurse -Filter "TESTPLUGIN.dll" | Select-Object -First 1
          
          if (-not $dll) {
            Write-Host "âŒ TESTPLUGIN.dll NOT FOUND!" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "`nğŸ“ DLL Location: $($dll.FullName)" -ForegroundColor Green
          Write-Host "ğŸ“Š File Size: $([math]::Round($dll.Length/1KB, 2)) KB" -ForegroundColor Green
          Write-Host "ğŸ“… Created: $($dll.CreationTime)" -ForegroundColor Green
          
          Write-Host "`n" + "â”€"*50 -ForegroundColor DarkGray
          Write-Host "1ï¸âƒ£ CORFLAGS CHECK (32-bit vs 64-bit)" -ForegroundColor Cyan
          Write-Host "â”€"*50 -ForegroundColor DarkGray
          & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\x64\corflags.exe" $dll.FullName
          
          Write-Host "`n" + "â”€"*50 -ForegroundColor DarkGray
          Write-Host "2ï¸âƒ£ ASSEMBLY VERSION & METADATA" -ForegroundColor Cyan
          Write-Host "â”€"*50 -ForegroundColor DarkGray
          try {
            [System.Reflection.Assembly]::ReflectionOnlyLoadFrom($dll.FullName) | Format-List FullName, ImageRuntimeVersion, GlobalAssemblyCache
          } catch {
            Write-Host "âš ï¸ Reflection Load Failed: $_" -ForegroundColor Yellow
          }
          
          Write-Host "`n" + "â”€"*50 -ForegroundColor DarkGray
          Write-Host "3ï¸âƒ£ DUMPBIN - PE HEADERS (Architecture)" -ForegroundColor Cyan
          Write-Host "â”€"*50 -ForegroundColor DarkGray
          & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.42.34433\bin\Hostx64\x64\dumpbin.exe" /headers $dll.FullName | Select-String -Pattern "(machine|magic|subsystem)"
          
          Write-Host "`n" + "â”€"*50 -ForegroundColor DarkGray
          Write-Host "4ï¸âƒ£ DUMPBIN - NATIVE DEPENDENCIES (Mixed Mode Check)" -ForegroundColor Cyan
          Write-Host "â”€"*50 -ForegroundColor DarkGray
          $deps = & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.42.34433\bin\Hostx64\x64\dumpbin.exe" /dependents $dll.FullName
          Write-Host $deps
          
          if ($deps -match "msvcr|msvcp|vcruntime") {
            Write-Host "âš ï¸ MIXED MODE DETECTED - C++ Runtime Dependencies Found!" -ForegroundColor Red
          } else {
            Write-Host "âœ… Pure Managed Assembly - No Native Dependencies" -ForegroundColor Green
          }
          
          Write-Host "`n" + "â”€"*50 -ForegroundColor DarkGray
          Write-Host "5ï¸âƒ£ ILDASM - IL CODE VALIDATION" -ForegroundColor Cyan
          Write-Host "â”€"*50 -ForegroundColor DarkGray
          & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\x64\ildasm.exe" /text /nobar $dll.FullName | Select-String -Pattern "(\.assembly|\.class|\.method.*Execute)" | Select-Object -First 20
          
          Write-Host "`n" + "â”€"*50 -ForegroundColor DarkGray
          Write-Host "6ï¸âƒ£ STRONG NAME & SIGNING STATUS" -ForegroundColor Cyan
          Write-Host "â”€"*50 -ForegroundColor DarkGray
          & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\x64\sn.exe" -vf $dll.FullName
          
          Write-Host "`n" + "â”€"*50 -ForegroundColor DarkGray
          Write-Host "7ï¸âƒ£ REFERENCED ASSEMBLIES (RevitAPI Check)" -ForegroundColor Cyan
          Write-Host "â”€"*50 -ForegroundColor DarkGray
          try {
            $asm = [System.Reflection.Assembly]::ReflectionOnlyLoadFrom($dll.FullName)
            $asm.GetReferencedAssemblies() | Format-Table Name, Version, ProcessorArchitecture -AutoSize
          } catch {
            Write-Host "âš ï¸ Cannot read references: $_" -ForegroundColor Yellow
          }
          
          Write-Host "`n" + "â”€"*50 -ForegroundColor DarkGray
          Write-Host "8ï¸âƒ£ FILE INTEGRITY & CHECKSUM" -ForegroundColor Cyan
          Write-Host "â”€"*50 -ForegroundColor DarkGray
          $hash = Get-FileHash $dll.FullName -Algorithm SHA256
          Write-Host "SHA256: $($hash.Hash)"
          
          Write-Host "`n" + "â”€"*50 -ForegroundColor DarkGray
          Write-Host "9ï¸âƒ£ COMPARISON WITH REVIT API DLLs" -ForegroundColor Cyan
          Write-Host "â”€"*50 -ForegroundColor DarkGray
          Write-Host "RevitAPI.dll:"
          & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\x64\corflags.exe" RevitAPI.dll | Select-String -Pattern "(PE|32BIT|ILONLY)"
          
          Write-Host "`n" + "â•"*50 -ForegroundColor Cyan
          Write-Host "âœ… DIAGNOSTICS COMPLETE" -ForegroundColor Green
          Write-Host "â•"*50 -ForegroundColor Cyan
          Write-Host "`nğŸ“‹ CRITICAL INDICATORS FOR LINE 146:" -ForegroundColor Yellow
          Write-Host "   â€¢ PE = PE32+ (not PE32)" -ForegroundColor White
          Write-Host "   â€¢ 32BITREQ = 0" -ForegroundColor White
          Write-Host "   â€¢ ILONLY = 1" -ForegroundColor White
          Write-Host "   â€¢ No MSVCR/MSVCP dependencies" -ForegroundColor White
          Write-Host "   â€¢ Assembly Version = 1.0.0.0" -ForegroundColor White
          Write-Host "`n"
      
      - name: ğŸ“¤ Upload DLL + Diagnostic Report
        uses: actions/upload-artifact@v4
        with:
          name: TESTPLUGIN-REVIT2025-DIAGNOSTICS
          path: |
            **/TESTPLUGIN.dll
            **/TESTPLUGIN.pdb
          retention-days: 90
      
      - name: ğŸ“Š Generate Summary Report
        shell: pwsh
        run: |
          $dll = Get-ChildItem -Recurse -Filter "TESTPLUGIN.dll" | Select-Object -First 1
          
          Write-Host "`nğŸ¯ QUICK REFERENCE FOR REVIT 2025:" -ForegroundColor Cyan
          Write-Host "   DLL Path: $($dll.FullName)"
          Write-Host "   Size: $([math]::Round($dll.Length/1KB, 2)) KB"
          Write-Host "`nğŸ“§ Share these logs with diagnostics above!"
