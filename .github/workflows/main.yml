name: Build TESTPLUGIN
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      
      - name: Download Revit APIs
        shell: pwsh
        run: |
          gh release download v1.0.0 --repo SHarpreet89/MyRevitAddin --pattern RevitApis.zip --dir .
          Expand-Archive RevitApis.zip -DestinationPath revapi -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPI.dll' | Select -First 1).FullName RevitAPI.dll
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPIUI.dll' | Select -First 1).FullName RevitAPIUI.dll
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build
        run: msbuild TESTPLUGIN.csproj /p:Configuration=Release /p:Platform=x64 /v:minimal
      
      - name: Diagnostics
        shell: pwsh
        run: |
          $dll = Get-ChildItem -Recurse -Filter "TESTPLUGIN.dll" | Select -First 1
          Write-Host "DLL: $($dll.FullName)"
          
          $corflags = & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\x64\corflags.exe" $dll.FullName | Out-String
          Write-Host $corflags
          
          $ildasm = & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\x64\ildasm.exe" /text /nobar $dll.FullName | Out-String
          $version = $ildasm -split "`n" | Where-Object { $_ -match "\.ver\s+\d+:\d+:\d+:\d+" } | Select -First 1
          Write-Host "Assembly Version: $version"
          
          if ($version -match "\.ver\s+1:0:0:0") {
            Write-Host "‚úÖ Version 1.0.0.0 CORRECT!" -ForegroundColor Green
          } else {
            Write-Host "‚ùå Version NOT 1.0.0.0!" -ForegroundColor Red
          }
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TESTPLUGIN-${{ github.sha }}
          path: |
            bin/x64/Release/TESTPLUGIN.dll
            bin/x64/Release/TESTPLUGIN.pdb
            TESTPLUGIN.addin
      
      - name: Show Download Link
        run: |
          echo "‚úÖ BUILD COMPLETE!"
          echo "üì¶ Download artifact from: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
