name: Build Revit Addin (.NET 8 - TESTPLUGIN Pure x64)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: üì¶ Download Revit API DLLs
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download v1.0.0 --repo SHarpreet89/MyRevitAddin --pattern RevitApis.zip --dir .
          Expand-Archive RevitApis.zip -DestinationPath revapi -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPI.dll' | Select -First 1).FullName RevitAPI.dll -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPIUI.dll' | Select -First 1).FullName RevitAPIUI.dll -Force

      - name: üèóÔ∏è dotnet publish Pure x64
        run: dotnet publish TESTPLUGIN.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=false -o ./publish

      - name: üîç Verify architecture
        shell: pwsh
        run: |
          $dll = "./publish/TESTPLUGIN.dll"
          Write-Host "üéØ DLL: $dll"
          $asm = [System.Reflection.AssemblyName]::GetAssemblyName($dll)
          Write-Host "Architecture: $($asm.ProcessorArchitecture)"
          & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\corflags.exe" $dll
          Write-Host "‚úÖ Verification complete ‚Äî expecting PE32+ and 32BITREQ=0"

      - name: üì§ Upload
        uses: actions/upload-artifact@v4
        with:
          name: TESTPLUGIN-REVIT2025
          path: ./publish/TESTPLUGIN.dll
          retention-days: 90
