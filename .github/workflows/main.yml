name: Build Revit Addin (.NET 8 - Pure x64 NO 32BITREQ)
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üß© Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: üì¶ Download Revit API DLLs
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download v1.0.0 --repo SHarpreet89/MyRevitAddin --pattern RevitApis.zip --dir .
          Expand-Archive RevitApis.zip -DestinationPath revapi -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPI.dll' | Select -First 1).FullName RevitAPI.dll -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPIUI.dll' | Select -First 1).FullName RevitAPIUI.dll -Force
          Write-Host "‚úÖ Revit API DLLs staged"

      - name: üèóÔ∏è MSBuild Pure x64
        shell: pwsh
        run: |
          & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe" MyRevitAddin.csproj /p:Configuration=Release /p:Platform=x64 /p:TargetFramework=net8.0-windows /p:PlatformTarget=x64 /p:Prefer32Bit=false /p:Requires32Bit=false /t:Restore,Build /maxcpucount /v:minimal

      - name: üîç Verify DLL (Simple)
        shell: pwsh
        run: |
          $dll = Get-ChildItem -Recurse -Filter "MyRevitAddin.dll" | Where-Object { $_.FullName -match "Release" -and $_.FullName -match "x64" } | Select-Object -First 1
          Write-Host "üéØ DLL: $($dll.FullName)"
          $asm = [System.Reflection.AssemblyName]::GetAssemblyName($dll.FullName)
          Write-Host "   Architecture: $($asm.ProcessorArchitecture)"
          corflags $dll.FullName
          Write-Host "‚úÖ Build complete - check 32BITREQ: 0 above"

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyRevitAddin-REVIT2025-CORRECT
          path: |
            bin/x64/Release/net8.0-windows/MyRevitAddin.dll
          retention-days: 90
