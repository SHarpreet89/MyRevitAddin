name: Build TESTPLUGIN (.NET 4.8 - Pure x64)
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: üß© Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: üì¶ Download Revit API DLLs
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download v1.0.0 --repo SHarpreet89/MyRevitAddin --pattern RevitApis.zip --dir .
          Expand-Archive RevitApis.zip -DestinationPath revapi -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPI.dll' | Select -First 1).FullName RevitAPI.dll -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPIUI.dll' | Select -First 1).FullName RevitAPIUI.dll -Force

      - name: üèóÔ∏è MSBuild TESTPLUGIN x64
        run: msbuild TESTPLUGIN.csproj /p:Configuration=Release /p:Platform=x64 /t:Restore,Build /maxcpucount

      - name: üîç Verify & List Files
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -Filter "TESTPLUGIN.dll" | ForEach-Object { Write-Host "üìÅ FOUND: $($_.FullName)" }
          $dll = "bin\x64\Release\net48\TESTPLUGIN.dll"
          if (Test-Path $dll) {
            Write-Host "üéØ DLL: $dll"
            & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\x64\corflags.exe" $dll
          } else {
            throw "‚ùå DLL not found at $dll"
          }

      - name: üì§ Upload
        uses: actions/upload-artifact@v4
        with:
          name: TESTPLUGIN-REVIT2025
          path: bin/x64/Release/net48/TESTPLUGIN.dll
          retention-days: 90
