name: Build TESTPLUGIN (.NET 4.8 - FINAL)
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: üß© Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: üì¶ Download Revit API DLLs
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download v1.0.0 --repo SHarpreet89/MyRevitAddin --pattern RevitApis.zip --dir .
          Expand-Archive RevitApis.zip -DestinationPath revapi -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPI.dll' | Select -First 1).FullName RevitAPI.dll -Force
          Copy-Item (Get-ChildItem -Recurse revapi -Filter 'RevitAPIUI.dll' | Select -First 1).FullName RevitAPIUI.dll -Force

      - name: üèóÔ∏è MSBuild TESTPLUGIN x64
        run: |
          msbuild TESTPLUGIN.csproj /p:Configuration=Release /p:Platform=x64 /maxcpucount /v:normal

      - name: üîç List & Verify
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -Name "*.dll" -Filter "*TESTPLUGIN*" | ForEach-Object { Write-Host "üìÅ $_" }
          $dll = Get-ChildItem -Recurse -Filter "TESTPLUGIN.dll" | Select-Object -First 1
          Write-Host "üéØ FULL PATH: $($dll.FullName)"
          & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\x64\corflags.exe" $dll.FullName

      - name: üì§ Upload
        uses: actions/upload-artifact@v4
        with:
          name: TESTPLUGIN-REVIT2025-FINAL
          path: |
            **/TESTPLUGIN.dll
          retention-days: 90
