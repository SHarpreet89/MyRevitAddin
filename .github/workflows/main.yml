name: Build Revit Addin

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install .NET Framework 4.8 Dev Pack
        run: choco install netfx-4.8-devpack -y

      # Use gdown to download from Google Drive (handles confirm token automatically)
      - name: Install gdown
        shell: pwsh
        run: |
          python -m pip install --upgrade pip gdown

      - name: Download Revit API ZIP from Google Drive
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $fileId = "1aZXAfLbdgVEWBY37_HGlByy8o82swHoi"
          python -m gdown --id $fileId -O RevitApis.zip

          # Sanity checks
          if (-not (Test-Path RevitApis.zip)) { throw "‚ùå RevitApis.zip not found after gdown." }
          $size = (Get-Item RevitApis.zip).Length
          Write-Host "üìè Downloaded ZIP size: $size bytes"
          if ($size -lt 10000) { throw "‚ùå Downloaded file suspiciously small." }

      - name: Extract and stage Revit API DLLs
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "üìÇ Extracting ZIP..."
          Expand-Archive -Path RevitApis.zip -DestinationPath . -Force

          Write-Host "üîç Searching for RevitAPI*.dll recursively‚Ä¶"
          $dlls = Get-ChildItem -Recurse -Filter "RevitAPI*.dll"
          if ($dlls.Count -eq 0) {
            Get-ChildItem -Recurse | ForEach-Object { $_.FullName }
            throw "‚ùå No RevitAPI*.dll found after extraction."
          }

          foreach ($dll in $dlls) {
            Write-Host "‚û° Copying $($dll.FullName) to repo root‚Ä¶"
            Copy-Item $dll.FullName -Destination . -Force
          }

          Write-Host "‚úÖ DLLs staged in root:"
          Get-ChildItem -Filter "RevitAPI*.dll" | ForEach-Object { $_.FullName }

      - name: Build Revit Addin
        run: msbuild MyRevitAddin.csproj /p:Configuration=Release /p:Platform="Any CPU"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyRevitAddin
          path: bin\Release\
